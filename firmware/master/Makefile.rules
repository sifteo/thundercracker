include $(TC_DIR)/firmware/master/Makefile.defs

all: $(BINS)

%.sim.o: %.cpp $(CDEPS)
	$(CC_SIM) -c -o $@ $< $(CCFLAGS_SIM)

%.stm32.o: %.cpp $(CDEPS)
	$(CC_STM32) -c -o $@ $< $(CCFLAGS_STM32)

ocd:
	openocd -f $(MASTER_DIR)/stm32/openocd.cfg

program: $(BIN_STM32)
	openocd -f $(MASTER_DIR)/stm32/openocd.cfg \
		-c init \
		-c "reset halt" \
		-c "flash write_image erase $<" \
		-c "reset run"

gdb:
	$(GDB_STM32) -x $(MASTER_DIR)/stm32/gdb.conf $(BIN_STM32)

$(BIN_SIM): $(OBJS_SIM) $(LIBS_SIM)
	$(CC_SIM) -o $@ $^ $(LDFLAGS_SIM)

$(BIN_STM32): $(OBJS_STM32) $(LIBS_STM32) $(LDSCRIPT_STM32)
	$(CC_STM32) -o $@ $(OBJS_STM32) $(LIBS_STM32) $(LDFLAGS_STM32)

$(ASSETS).gen.cpp: $(STIR) $(ASSETDEPS)
	$(STIR) $(ASSETS).lua -o $(ASSETS).gen.cpp -o $(ASSETS).gen.h -o $(ASSETS).html -v

.PHONY: clean all ocd program gdb

clean:
	rm -f $(BINS) *.o $(ASSETS).gen.h $(ASSETS).gen.cpp $(ASSETS).html
