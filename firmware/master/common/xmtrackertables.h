/*
 * Thundercracker Firmware -- Confidential, not for redistribution.
 * Copyright <c> 2012 Sifteo, Inc. All rights reserved.
 */

#ifndef XMTRACKERTABLES_H_
#define XMTRACKERTABLES_H_

/* Amiga period lookup table (96 notes)
 *
 * The file spec provides this table. Duplicated for reference:
 *
 * Pos = (Note % 12) * 8 + FineTune / 16
 * Frac = FineTune / 16 - Int(FineTune / 16)
 * Period = (PeriodTab[Pos] * (1 - Frac) + PeriodTab[Pos+1] * Frac) * 16 / pow(2, Note/12)
 * Frequency = 8363 * 1712 / Period
 */
const uint16_t XmTrackerPlayer::AmigaPeriodTab[12 * 8] = {
	907,900,894,887,881,875,868,862,
	856,850,844,838,832,826,820,814,
	808,802,796,791,785,779,774,768,
	762,757,752,746,741,736,730,725,
	720,715,709,704,699,694,689,684,
	678,675,670,665,660,655,651,646,
	640,636,632,628,623,619,614,610,
	604,601,597,592,588,584,580,575,
	570,567,563,559,555,551,547,543,
	538,535,532,528,524,520,516,513,
	508,505,502,498,494,491,487,484,
	480,477,474,470,467,463,460,457
};

/* Linear frequency lookup table.
 *
 * The equation in the file spec:
 *
 *  Frequency = 8363 * pow(2, (6*12*16*4-Period)/(12*16*4))
 *
 * requires raising 2 to a fractional power, which is some expensive
 * floating point power math.
 */
const uint32_t XmTrackerPlayer::LinearFrequencyTab[768] = {
	535232,534749,534266,533784,533303,532822,532341,531861,
	531381,530902,530423,529944,529466,528988,528511,528034,
	527558,527082,526607,526131,525657,525183,524709,524236,
	523763,523290,522818,522346,521875,521404,520934,520464,
	519994,519525,519057,518588,518121,517653,517186,516720,
	516253,515788,515322,514858,514393,513929,513465,513002,
	512539,512077,511615,511154,510692,510232,509771,509312,
	508852,508393,507934,507476,507018,506561,506104,505647,
	505191,504735,504280,503825,503371,502917,502463,502010,
	501557,501104,500652,500201,499749,499298,498848,498398,
	497948,497499,497050,496602,496154,495706,495259,494812,
	494366,493920,493474,493029,492585,492140,491696,491253,
	490809,490367,489924,489482,489041,488600,488159,487718,
	487278,486839,486400,485961,485522,485084,484647,484210,
	483773,483336,482900,482465,482029,481595,481160,480726,
	480292,479859,479426,478994,478562,478130,477699,477268,
	476837,476407,475977,475548,475119,474690,474262,473834,
	473407,472979,472553,472126,471701,471275,470850,470425,
	470001,469577,469153,468730,468307,467884,467462,467041,
	466619,466198,465778,465358,464938,464518,464099,463681,
	463262,462844,462427,462010,461593,461177,460760,460345,
	459930,459515,459100,458686,458272,457859,457446,457033,
	456621,456209,455797,455386,454975,454565,454155,453745,
	453336,452927,452518,452110,451702,451294,450887,450481,
	450074,449668,449262,448857,448452,448048,447644,447240,
	446836,446433,446030,445628,445226,444824,444423,444022,
	443622,443221,442821,442422,442023,441624,441226,440828,
	440430,440033,439636,439239,438843,438447,438051,437656,
	437261,436867,436473,436079,435686,435293,434900,434508,
	434116,433724,433333,432942,432551,432161,431771,431382,
	430992,430604,430215,429827,429439,429052,428665,428278,
	427892,427506,427120,426735,426350,425965,425581,425197,
	424813,424430,424047,423665,423283,422901,422519,422138,
	421757,421377,420997,420617,420237,419858,419479,419101,
	418723,418345,417968,417591,417214,416838,416462,416086,
	415711,415336,414961,414586,414212,413839,413465,413092,
	412720,412347,411975,411604,411232,410862,410491,410121,
	409751,409381,409012,408643,408274,407906,407538,407170,
	406803,406436,406069,405703,405337,404971,404606,404241,
	403876,403512,403148,402784,402421,402058,401695,401333,
	400970,400609,400247,399886,399525,399165,398805,398445,
	398086,397727,397368,397009,396651,396293,395936,395579,
	395222,394865,394509,394153,393798,393442,393087,392733,
	392378,392024,391671,391317,390964,390612,390259,389907,
	389556,389204,388853,388502,388152,387802,387452,387102,
	386753,386404,386056,385707,385359,385012,384664,384317,
	383971,383624,383278,382932,382587,382242,381897,381552,
	381208,380864,380521,380177,379834,379492,379149,378807,
	378466,378124,377783,377442,377102,376762,376422,376082,
	375743,375404,375065,374727,374389,374051,373714,373377,
	373040,372703,372367,372031,371695,371360,371025,370690,
	370356,370022,369688,369355,369021,368688,368356,368023,
	367691,367360,367028,366697,366366,366036,365706,365376,
	365046,364717,364388,364059,363731,363403,363075,362747,
	362420,362093,361766,361440,361114,360788,360463,360137,
	359813,359488,359164,358840,358516,358193,357869,357547,
	357224,356902,356580,356258,355937,355616,355295,354974,
	354654,354334,354014,353695,353376,353057,352739,352420,
	352103,351785,351468,351150,350834,350517,350201,349885,
	349569,349254,348939,348624,348310,347995,347682,347368,
	347055,346741,346429,346116,345804,345492,345180,344869,
	344558,344247,343936,343626,343316,343006,342697,342388,
	342079,341770,341462,341154,340846,340539,340231,339924,
	339618,339311,339005,338700,338394,338089,337784,337479,
	337175,336870,336566,336263,335959,335656,335354,335051,
	334749,334447,334145,333844,333542,333242,332941,332641,
	332341,332041,331741,331442,331143,330844,330546,330247,
	329950,329652,329355,329057,328761,328464,328168,327872,
	327576,327280,326985,326690,326395,326101,325807,325513,
	325219,324926,324633,324340,324047,323755,323463,323171,
	322879,322588,322297,322006,321716,321426,321136,320846,
	320557,320267,319978,319690,319401,319113,318825,318538,
	318250,317963,317676,317390,317103,316817,316532,316246,
	315961,315676,315391,315106,314822,314538,314254,313971,
	313688,313405,313122,312839,312557,312275,311994,311712,
	311431,311150,310869,310589,310309,310029,309749,309470,
	309190,308911,308633,308354,308076,307798,307521,307243,
	306966,306689,306412,306136,305860,305584,305308,305033,
	304758,304483,304208,303934,303659,303385,303112,302838,
	302565,302292,302019,301747,301475,301203,300931,300660,
	300388,300117,299847,299576,299306,299036,298766,298497,
	298227,297958,297689,297421,297153,296884,296617,296349,
	296082,295815,295548,295281,295015,294749,294483,294217,
	293952,293686,293421,293157,292892,292628,292364,292100,
	291837,291574,291311,291048,290785,290523,290261,289999,
	289737,289476,289215,288954,288693,288433,288173,287913,
	287653,287393,287134,286875,286616,286358,286099,285841,
	285583,285326,285068,284811,284554,284298,284041,283785,
	283529,283273,283017,282762,282507,282252,281998,281743,
	281489,281235,280981,280728,280475,280222,279969,279716,
	279464,279212,278960,278708,278457,278206,277955,277704,
	277453,277203,276953,276703,276453,276204,275955,275706,
	275457,275209,274960,274712,274465,274217,273970,273722,
	273476,273229,272982,272736,272490,272244,271999,271753,
	271508,271263,271018,270774,270530,270286,270042,269798,
	269555,269312,269069,268826,268583,268341,268099,267857
};

uint32_t XmTrackerPlayer::getPeriod(uint16_t note, int8_t finetune) const {
    ASSERT(note < XmTrackerPattern::kNoteOff);
    if (note >= XmTrackerPattern::kNoteOff) return 0;

    if (song.frequencyTable == kLinearFrequencies) {
        // From file spec: Period = 10 â€¢Â 12 â€¢Â 16 â€¢Â 4 - Note â€¢Â 16 â€¢Â 4 - FineTune / 2
        int32_t period = (10 * 12 * 16 * 4) -
                         (((int32_t)note - 1) * 16 * 4) -
                         ((int32_t)finetune / 2);

        if (period <= 0) {
            LOG(("note: %u, finetune: %u resulted in <= 0 period\n", note, finetune));
            ASSERT(period >= 0);
        }

        return (uint32_t)MAX(period, 0);
    } else {
        ASSERT(song.frequencyTable == kAmigaFrequencies);

        /* Duplicated from above, computing Amiga periods/frequencies:
         *
         * Pos = (Note % 12) * 8 + FineTune / 16
         * Frac = FineTune / 16 - Int(FineTune / 16)
         * Period = (PeriodTab[Pos] * (1 - Frac) + PeriodTab[Pos+1] * Frac) * 16 / pow(2, Note/12)
         * Frequency = 8363 * 1712 / Period
         */
        uint8_t pos = (note % 12) * 8 + finetune / 16;

        // Fixed-point integer math is faster than floating point.
        uint8_t frac = (finetune % 16);

        // Base table value
        uint32_t period = XmTrackerPlayer::AmigaPeriodTab[pos] * ((~frac & 0xF) + 1) / 16;
        // Interpolated with next table value
        period += XmTrackerPlayer::AmigaPeriodTab[pos + 1] * frac / 16;
        /* Restore octave to note using bit shifts instead of exponents.
         * shifting 5 instead of 4 because the unofficial file spec differs
         * from implementations in the wild by a factor of 2.
         */
        period = (period << 5) / (1 << (note / 12));

        return period;
    }
}

uint32_t XmTrackerPlayer::getFrequency(uint32_t period) const {
    ASSERT(song.nPatterns);

    if (song.frequencyTable == kLinearFrequencies) {
        int32_t shift = (int32_t)period / arraysize(LinearFrequencyTab);
        int32_t pos = period % arraysize(LinearFrequencyTab);

        if (shift > 0) {
            return LinearFrequencyTab[pos] >> shift;
        } else {
            return LinearFrequencyTab[pos] << (-shift);
        }
    } else {
        ASSERT(song.frequencyTable == kAmigaFrequencies);
        // See: getPeriod(...)
        return 8363 * 1712 / period;
    }
}

#endif // XMTRACKERTABLES_H_
