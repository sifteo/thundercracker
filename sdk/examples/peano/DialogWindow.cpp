#include "DialogWindow.h"
#include "assets.gen.h"

using namespace Sifteo;

namespace TotalsGame
{

static const uint8_t font_data[] = {
    0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x02,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x00,0x01,0x00,0x00,
    0x04,0x00,0x00,0x05,0x05,0x05,0x00,0x00,0x00,0x00,0x00,0x00,
    0x06,0x00,0x00,0x0a,0x1f,0x0a,0x1f,0x0a,0x00,0x00,0x00,0x00,
    0x06,0x00,0x04,0x0e,0x15,0x05,0x0e,0x14,0x15,0x0e,0x04,0x00,
    0x06,0x00,0x00,0x12,0x15,0x0a,0x04,0x0a,0x15,0x09,0x00,0x00,
    0x06,0x00,0x00,0x06,0x09,0x05,0x02,0x15,0x09,0x16,0x00,0x00,
    0x02,0x00,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x04,0x00,0x04,0x02,0x02,0x01,0x01,0x01,0x02,0x02,0x04,0x00,
    0x04,0x00,0x01,0x02,0x02,0x04,0x04,0x04,0x02,0x02,0x01,0x00,
    0x06,0x00,0x00,0x04,0x15,0x0e,0x15,0x04,0x00,0x00,0x00,0x00,
    0x06,0x00,0x00,0x00,0x04,0x04,0x1f,0x04,0x04,0x00,0x00,0x00,
    0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x02,0x01,
    0x05,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,0x00,0x00,0x00,
    0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x03,0x03,0x00,0x00,
    0x06,0x10,0x10,0x08,0x08,0x04,0x04,0x02,0x02,0x01,0x01,0x00,
    0x06,0x00,0x00,0x0e,0x11,0x19,0x15,0x13,0x11,0x0e,0x00,0x00,
    0x03,0x00,0x00,0x02,0x03,0x02,0x02,0x02,0x02,0x02,0x00,0x00,
    0x06,0x00,0x00,0x0e,0x11,0x10,0x08,0x04,0x02,0x1f,0x00,0x00,
    0x06,0x00,0x00,0x0e,0x11,0x10,0x0c,0x10,0x11,0x0e,0x00,0x00,
    0x06,0x00,0x00,0x08,0x0c,0x0a,0x09,0x1f,0x08,0x08,0x00,0x00,
    0x06,0x00,0x00,0x1f,0x01,0x0f,0x10,0x10,0x11,0x0e,0x00,0x00,
    0x06,0x00,0x00,0x0e,0x01,0x0f,0x11,0x11,0x11,0x0e,0x00,0x00,
    0x06,0x00,0x00,0x1f,0x10,0x10,0x08,0x04,0x04,0x04,0x00,0x00,
    0x06,0x00,0x00,0x0e,0x11,0x11,0x0e,0x11,0x11,0x0e,0x00,0x00,
    0x06,0x00,0x00,0x0e,0x11,0x11,0x11,0x1e,0x10,0x0e,0x00,0x00,
    0x03,0x00,0x00,0x00,0x03,0x03,0x00,0x00,0x03,0x03,0x00,0x00,
    0x03,0x00,0x00,0x00,0x03,0x03,0x00,0x00,0x03,0x03,0x02,0x01,
    0x05,0x00,0x00,0x08,0x04,0x02,0x01,0x02,0x04,0x08,0x00,0x00,
    0x05,0x00,0x00,0x00,0x00,0x0f,0x00,0x0f,0x00,0x00,0x00,0x00,
    0x05,0x00,0x00,0x01,0x02,0x04,0x08,0x04,0x02,0x01,0x00,0x00,
    0x06,0x00,0x00,0x0e,0x11,0x10,0x08,0x04,0x00,0x04,0x00,0x00,
    0x06,0x00,0x0e,0x11,0x11,0x15,0x17,0x0d,0x01,0x11,0x0e,0x00,
    0x06,0x00,0x00,0x0e,0x11,0x11,0x1f,0x11,0x11,0x11,0x00,0x00,
    0x06,0x00,0x00,0x0f,0x11,0x11,0x0f,0x11,0x11,0x0f,0x00,0x00,
    0x06,0x00,0x00,0x0e,0x11,0x01,0x01,0x01,0x11,0x0e,0x00,0x00,
    0x06,0x00,0x00,0x0f,0x11,0x11,0x11,0x11,0x11,0x0f,0x00,0x00,
    0x06,0x00,0x00,0x1f,0x01,0x01,0x0f,0x01,0x01,0x1f,0x00,0x00,
    0x06,0x00,0x00,0x1f,0x01,0x01,0x0f,0x01,0x01,0x01,0x00,0x00,
    0x06,0x00,0x00,0x0e,0x11,0x01,0x19,0x11,0x11,0x0e,0x00,0x00,
    0x06,0x00,0x00,0x11,0x11,0x11,0x1f,0x11,0x11,0x11,0x00,0x00,
    0x02,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,
    0x06,0x00,0x00,0x10,0x10,0x10,0x10,0x11,0x11,0x0e,0x00,0x00,
    0x06,0x00,0x00,0x11,0x09,0x05,0x03,0x05,0x09,0x11,0x00,0x00,
    0x06,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x1f,0x00,0x00,
    0x06,0x00,0x00,0x11,0x1b,0x15,0x11,0x11,0x11,0x11,0x00,0x00,
    0x06,0x00,0x00,0x11,0x13,0x15,0x19,0x11,0x11,0x11,0x00,0x00,
    0x06,0x00,0x00,0x0e,0x11,0x11,0x11,0x11,0x11,0x0e,0x00,0x00,
    0x06,0x00,0x00,0x0f,0x11,0x11,0x0f,0x01,0x01,0x01,0x00,0x00,
    0x06,0x00,0x00,0x0e,0x11,0x11,0x11,0x11,0x11,0x0e,0x10,0x00,
    0x06,0x00,0x00,0x0f,0x11,0x11,0x0f,0x11,0x11,0x11,0x00,0x00,
    0x06,0x00,0x00,0x0e,0x11,0x01,0x0e,0x10,0x11,0x0e,0x00,0x00,
    0x06,0x00,0x00,0x1f,0x04,0x04,0x04,0x04,0x04,0x04,0x00,0x00,
    0x06,0x00,0x00,0x11,0x11,0x11,0x11,0x11,0x11,0x0e,0x00,0x00,
    0x06,0x00,0x00,0x11,0x11,0x11,0x0a,0x0a,0x04,0x04,0x00,0x00,
    0x06,0x00,0x00,0x11,0x11,0x11,0x11,0x15,0x1b,0x11,0x00,0x00,
    0x06,0x00,0x00,0x11,0x0a,0x04,0x04,0x04,0x0a,0x11,0x00,0x00,
    0x06,0x00,0x00,0x11,0x11,0x11,0x0a,0x04,0x04,0x04,0x00,0x00,
    0x06,0x00,0x00,0x1f,0x10,0x08,0x04,0x02,0x01,0x1f,0x00,0x00,
    0x03,0x00,0x03,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x03,0x00,
    0x06,0x01,0x01,0x02,0x02,0x04,0x04,0x08,0x08,0x10,0x10,0x00,
    0x03,0x00,0x03,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x03,0x00,
    0x06,0x00,0x04,0x0a,0x11,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x0f,0x00,0x00,
    0x04,0x00,0x01,0x02,0x04,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x1e,0x11,0x11,0x19,0x16,0x00,0x00,
    0x06,0x00,0x00,0x01,0x01,0x0f,0x11,0x11,0x11,0x0f,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x0e,0x11,0x01,0x01,0x1e,0x00,0x00,
    0x06,0x00,0x00,0x10,0x10,0x1e,0x11,0x11,0x11,0x1e,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x0e,0x11,0x1f,0x01,0x1e,0x00,0x00,
    0x05,0x00,0x00,0x0c,0x02,0x07,0x02,0x02,0x02,0x02,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x1e,0x11,0x11,0x11,0x1e,0x10,0x0e,
    0x06,0x00,0x00,0x01,0x01,0x0f,0x11,0x11,0x11,0x11,0x00,0x00,
    0x02,0x00,0x00,0x01,0x00,0x01,0x01,0x01,0x01,0x01,0x00,0x00,
    0x04,0x00,0x00,0x04,0x00,0x04,0x04,0x04,0x04,0x04,0x04,0x03,
    0x06,0x00,0x00,0x01,0x01,0x09,0x05,0x07,0x09,0x11,0x00,0x00,
    0x03,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x03,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x0f,0x15,0x15,0x15,0x15,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x0d,0x13,0x11,0x11,0x11,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x0e,0x11,0x11,0x11,0x0e,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x0f,0x11,0x11,0x11,0x0f,0x01,0x01,
    0x06,0x00,0x00,0x00,0x00,0x1e,0x11,0x11,0x11,0x1e,0x10,0x10,
    0x06,0x00,0x00,0x00,0x00,0x0d,0x13,0x01,0x01,0x01,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x1e,0x01,0x0e,0x10,0x0f,0x00,0x00,
    0x05,0x00,0x00,0x02,0x02,0x0f,0x02,0x02,0x02,0x0c,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x11,0x11,0x11,0x19,0x16,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x11,0x11,0x0a,0x0a,0x04,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x15,0x15,0x15,0x15,0x0a,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x11,0x0a,0x04,0x0a,0x11,0x00,0x00,
    0x06,0x00,0x00,0x00,0x00,0x11,0x11,0x11,0x11,0x1e,0x10,0x0e,
    0x06,0x00,0x00,0x00,0x00,0x1f,0x08,0x04,0x02,0x1f,0x00,0x00,
};

#define kFontHeight 11



DialogWindow::DialogWindow(TotalsCube* pCube) : mCube(pCube) {
    fg = RGB565::fromRGB((uint8_t)0,(uint8_t)0,(uint8_t)0);
    bg = RGB565::fromRGB((uint8_t)255,(uint8_t)255,(uint8_t)255);
}

void DialogWindow::SetBackgroundColor(uint8_t r, uint8_t g, uint8_t b)
{
    bg = RGB565::fromRGB(r, g, b);
}

void DialogWindow::SetForegroundColor(uint8_t r, uint8_t g, uint8_t b)
{
    fg = RGB565::fromRGB(r, g, b);
}

const char* DialogWindow::Show(const char* str) {
    unsigned count, length;
    MeasureText(str, &count, &length);
    mPosition.x = (128 - length) >> 1;
    DrawText(str);
    mPosition.y += kFontHeight + 1;
    return str + count;
}

void DialogWindow::DrawGlyph(char ch) {
    uint8_t index = ch - ' ';
    const uint8_t *data = font_data + (index * kFontHeight) + index;
    uint8_t escapement = *(data++);
    mCube->vid.fb128.bitmap(mPosition, vec(8, kFontHeight), data, 1);

    mPosition.x += escapement;    
}

unsigned DialogWindow::MeasureGlyph(char ch) {
    uint8_t index = ch - ' ';
    const uint8_t *data = font_data + (index * kFontHeight) + index;
    return data[0];
}

void DialogWindow::DrawText(const char *str) {
    char c;
    while ((c = *str) && c != '\n') {
        str++;
        DrawGlyph(c);
    }
}

void DialogWindow::MeasureText(const char *str, unsigned *outCount, unsigned *outPx) {
    *outPx = 0;
    *outCount = 0;
    char c;
    while ((c = *str) && c != '\n') {
        str++;
        (*outCount)++;
        *outPx += MeasureGlyph(c);
    }
    if (c) { (*outCount)++; }
}

void DialogWindow::DoDialog(const char *text, int yTop, int ySize)
{
    mCube->vid.touch();
    System::paint();
    System::finish();


    mCube->vid.initMode(FB128);
    mCube->vid.setWindow(yTop, ySize);
    mCube->vid.colormap[0].set(fg);
    mCube->vid.colormap[1].set(bg);

    mPosition.y = 3;
    const char* pNextChar = text;
    while(*pNextChar) {
        pNextChar = Show(pNextChar);
    }

    System::paint();
}

void DialogWindow::ChangeText(const char *text)
{
    mCube->vid.fb128.fill(0);
    mPosition.y = 3;
    const char* pNextChar = text;
    while(*pNextChar) {
        pNextChar = Show(pNextChar);
    }

    System::paint();
}

void DialogWindow::EndIt()
{
    mCube->vid.initMode(BG0_SPR_BG1);
    mCube->vid.setWindow(0, 128);
}

}
